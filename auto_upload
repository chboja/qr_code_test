import tkinter as tk
from tkinter import messagebox
import threading

# "ì‘ì—… ì¤‘" ìœˆë„ìš°ë¥¼ ë„ìš°ëŠ” í•¨ìˆ˜
def show_working_window():
    root = tk.Tk()
    root.title("ì²˜ë¦¬ ì¤‘")
    root.geometry("300x100")
    label = tk.Label(root, text="ê³ ê° ì •ë³´ ê°±ì‹  ì¤‘...", font=("Arial", 14))
    label.pack(expand=True)
    root.attributes('-topmost', True)
    # return root so we can destroy it later
    return root

# íŒì—… ë©”ì‹œì§€ í•¨ìˆ˜ ì •ì˜
def show_message(title, message):
    root = tk.Tk()
    root.withdraw()
    messagebox.showinfo(title, message)
    root.destroy()
import pandas as pd
import hashlib
import re
import jaconv

csv_file_path = "reservation_2025-05-16.csv"

secret = "HOTEL_ONLY_SECRET_KEY"

def generate_hash(room, check_in, check_out, reservation, breakfast_flag):
    data = f"{room},{check_in},{check_out},{reservation},{breakfast_flag}"
    return hashlib.sha256((data + secret).encode("utf-8")).hexdigest()[:8]

def format_date(raw):
    try:
        dt = pd.to_datetime(raw)
        return dt.strftime("%Y-%m-%d")
    except:
        return ""

def normalize_search_name(name):
    name = str(name).strip()
    if re.match(r'^[\x00-\x7F\s]+$', name):
        return name.lower()
    return jaconv.hira2kata(jaconv.z2h(name, kana=True, digit=False, ascii=False))

df = pd.read_csv(csv_file_path, encoding="cp932")

rows = []
for _, row in df.iterrows():
    if str(row.get("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "")).strip() == "ã‚­ãƒ£ãƒ³ã‚»ãƒ«":
        continue

    reservation = str(row.get("#äºˆç´„ç•ªå·", "")).strip()
    raw_room = str(row.get("éƒ¨å±‹å", "")).strip()
    room_match = re.search(r"\d{1,3}", raw_room)
    room = room_match.group(0) if room_match else raw_room

    name = str(row.get("äºˆç´„è€…", "")).strip()
    check_in = format_date(row.get("C/I", ""))
    check_out = format_date(row.get("C/O", ""))
    guests = str(row.get("å¤§äººäººæ•°", "")).strip()
    plan = str(row.get("ãƒ—ãƒ©ãƒ³å", "")).lower()

    breakfast_flag = "0" if "room only" in plan else "1"
    hashcode = generate_hash(room, check_in, check_out, reservation, breakfast_flag)
    search_name = normalize_search_name(name)

    unpaid_raw = str(row.get("æœªåé‡‘", "")).strip()
    unpaid = "0" if unpaid_raw == "ãªã—" else unpaid_raw.replace(",", "ã€")

    memo = str(row.get("ãƒ¡ãƒ¢", "")).strip().replace(",", "ã€")

    csv_line = ",".join([
        reservation,
        room,
        name,
        check_in,
        check_out,
        guests,
        breakfast_flag,
        search_name,
        hashcode,
        unpaid,
        memo
    ])
    rows.append(csv_line)

# GASë¡œ ë³´ë‚¼ ì „ì²´ ë¬¸ìì—´ (ì„¸ë¯¸ì½œë¡ ìœ¼ë¡œ êµ¬ë¶„)
final_payload = ";".join(rows)
# print(final_payload)  # EXEì—ì„œëŠ” ì¶œë ¥í•˜ì§€ ì•ŠìŒ


import requests

GAS_URL = "https://script.google.com/macros/s/AKfycbz8gAPzSSjqgmXgWYqZJb4HAf2A7Bt3j70FKngVsiJ7yrGiGAND9QH61iSBdOu7qMDeYw/exec"

# "ì‘ì—… ì¤‘" ìœˆë„ìš° ê´€ë¦¬ ë³€ìˆ˜
working_root = None
def _start_working_window():
    global working_root
    working_root = show_working_window()
    working_root.mainloop()

# 1. Clear existing sheet data
clear_response = requests.get(GAS_URL, params={"command": "clear"})
show_message("ì´ˆê¸°í™” ì™„ë£Œ", f"ğŸ§¹ ì‹œíŠ¸ ì´ˆê¸°í™” ê²°ê³¼: {clear_response.json()}")

# ì—…ë¡œë“œ ì‹œì‘ ì•ˆë‚´ ë° "ì‘ì—… ì¤‘" ìœˆë„ìš° ë„ìš°ê¸°
working_thread = threading.Thread(target=_start_working_window)
working_thread.daemon = True
working_thread.start()

show_message("ì—…ë¡œë“œ ì‹œì‘", "êµ¬ê¸€ì‹œíŠ¸ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
# 2. Upload new data via POST
upload_response = requests.post(GAS_URL, data={"csv": final_payload})
# print("ğŸ“¤ POST ë°©ì‹ ì—…ë¡œë“œ ê²°ê³¼:", upload_response.json())

# âœ… ì—…ë¡œë“œ ê²°ê³¼ì— ë”°ë¼ ì¢…ë£Œ ì—¬ë¶€ íŒë‹¨
import sys

def close_working_window():
    global working_root
    if working_root is not None:
        try:
            working_root.destroy()
        except Exception:
            pass
        working_root = None

if upload_response.ok:
    result = upload_response.json()
    if result.get("success"):
        close_working_window()
        show_message("ì„±ê³µ", "âœ… êµ¬ê¸€ì‹œíŠ¸ ì—…ë¡œë“œ ì™„ë£Œ!")
        sys.exit(0)
    else:
        close_working_window()
        show_message("ì—…ë¡œë“œ ì‹¤íŒ¨", f"âŒ ì˜¤ë¥˜: {result}")
        sys.exit(1)
else:
    close_working_window()
    show_message("ìš”ì²­ ì‹¤íŒ¨", f"âŒ ìƒíƒœ ì½”ë“œ: {upload_response.status_code}")
    sys.exit(1)

# 3. (ì„ íƒ) GET ë°©ì‹ìœ¼ë¡œ ì—…ë¡œë“œ ì˜ˆì‹œ (ë°ì´í„°ê°€ ì§§ì„ ê²½ìš°ì—ë§Œ)
# ì°¸ê³ : URL ê¸¸ì´ ì œí•œ (~2000ì)ë¡œ ì¸í•´ ë§ì€ ë°ì´í„°ì—ëŠ” ì í•©í•˜ì§€ ì•ŠìŒ
# import urllib.parse
#
# if len(final_payload) < 1800:
#     get_url = f"{GAS_URL}?csv={urllib.parse.quote(final_payload)}"
#     get_upload_response = requests.get(get_url)
#     print("ğŸ“¤ GET ë°©ì‹ ì—…ë¡œë“œ ê²°ê³¼:", get_upload_response.json())
# else:
#     print("âš ï¸ GET ë°©ì‹ì€ ë°ì´í„°ê°€ ë„ˆë¬´ ê¸¸ì–´ì„œ ìƒëµë¨ (ê¸¸ì´:", len(final_payload), ")")